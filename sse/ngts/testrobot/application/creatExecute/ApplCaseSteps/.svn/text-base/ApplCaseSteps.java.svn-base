package sse.ngts.testrobot.application.creatExecute.ApplCaseSteps;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.util.ArrayList;
import java.util.Hashtable;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;

import sse.ngts.testrobot.application.functions.AppSheetRead;
import sse.ngts.testrobot.engine.app.ApplExecuteResultDialog;
import sse.ngts.testrobot.engine.unit.ApplCase;
import sse.ngts.testrobot.engine.unit.ApplConstValues;
import sse.ngts.testrobot.engine.unit.ApplFrmwkCase;
import sse.ngts.testrobot.exception.ApplFatalException;

public class ApplCaseSteps{
    private ArrayList<ApplFrmwkCase> steps;
	
	public ApplCaseSteps()
	{		
			
	}
	/*************************************
	 *函数功能: 从用例或框架文件中获取所有步骤
	 *函数输入：
	 *String sheetNm        －－脚本表单名称
	 *File file             －－脚本路径
	 *int num               －－从第几行开始读
	 *ApplCase caseDetail   －－用例详情
	 *函数返回值：
	 *空
	 *************************************/
	public Boolean readCaseStep(String sheetNm, File file,int num,ApplCase caseDetail)
    {
		
	 		 
		Logger.getLogger(ApplConstValues.logName).
		                 entering("ApplCaseSteps", "readCaseStep");
		try
        {
            Hashtable dupCaseChk = new Hashtable();
            FileInputStream in = new FileInputStream(file);
            HSSFWorkbook workbook = new HSSFWorkbook(in);
            HSSFSheet sheet = workbook.getSheet(sheetNm);
            if (sheet == null)
            {
            }
            int numberOfRows = sheet.getPhysicalNumberOfRows();
            String titleDesc[] = null;
            steps = new ArrayList<ApplFrmwkCase>();

            for (int j = num; j < numberOfRows; j++)
            {
                HSSFRow row = sheet.getRow(j);
                
                if (row == null)
                {
                    continue;
                }
                if (j == num)
                {
                    titleDesc = AppSheetRead.getTitleDesc(row);
                    if(!AppSheetRead.deteTilt(titleDesc,ApplConstValues.stepTitle, file.getAbsolutePath()))
                		return false;                	
                }
                else
                {
                	Hashtable<String,String> values = AppSheetRead.wrapValues(titleDesc, row);
                    if(values.get("脚本编号").toString().isEmpty())
                        continue;
                    if(values.get("交易日").toString().isEmpty())
                    {
                    	Logger.getLogger(ApplConstValues.logName).
                    	  log(Level.SEVERE, "步骤{0}的交易日字段为空",caseDetail.getCaseId()+"_"+
               		         values.get("脚本编号").toString());
                    	return false;
                    }
                    if(!values.get("交易日").toString().trim().toUpperCase().startsWith("T")||!values.get("交易日").toString().trim().substring(1).matches("[0-9]+"))
                    {
                    	Logger.getLogger(ApplConstValues.logName).
                    	  log(Level.SEVERE, "步骤{0}的交易日字段值格式错误！",caseDetail.getCaseId()+"_"+
               		         values.get("脚本编号").toString());
                    	
                    }
                    if(values.get("执行阶段").toString().isEmpty())
                    {                    	
                    	Logger.getLogger(ApplConstValues.logName).
                  	       log(Level.SEVERE, "步骤{0}的执行阶段字段为空",caseDetail.getCaseId()+"_"+
                		         values.get("脚本编号").toString());
                    	  return false;
                    }
                    if(values.get("错误状态").toString().isEmpty())
                    {
                    	Logger.getLogger(ApplConstValues.logName).
                        log(Level.SEVERE, "步骤{0}的错误状态为空",caseDetail.getCaseId()+"_"+
                        		         values.get("脚本编号").toString());
                    	Logger.getLogger(ApplConstValues.logName).
           	            log(Level.SEVERE, "执行手册生成失败 ");
						ApplExecuteResultDialog.viewError("执行失败，步骤"+caseDetail.getCaseId()+"_"+
								 values.get("脚本编号").toString()+"错误状态为空", "ERROR");
						return false;
                    }
                    if(-1=="ynrlYNRL".indexOf(values.get("错误状态").toString().trim()))
                    {
                    	ApplExecuteResultDialog.viewError("执行失败,原因"+
                    			caseDetail.getCaseId()+"_"+
               		         values.get("脚本编号").toString()+
                    			"的错误状态 不对", "ERROR");
                    	Logger.getLogger(ApplConstValues.logName).
                    	     log(Level.SEVERE, "步骤{0}的错误状态不对",caseDetail.getCaseId()+"_"+
               		         values.get("脚本编号").toString());
           	            Logger.getLogger(ApplConstValues.logName).
  	                           log(Level.SEVERE, "执行手册生成失败 ");
           	            return false;
                    }
                    if(values.get("脚本执行内容").toString().isEmpty())
                    {                    	
                    	Logger.getLogger(ApplConstValues.logName).
                  	       log(Level.SEVERE, "步骤{0}的脚本执行内容字段为空",caseDetail.getCaseId()+"_"+
                		         values.get("脚本编号").toString());
                    	  return false;
                    }
                    ApplStepsSet step = new ApplStepsSet();
                    step.setApplSteps(values,caseDetail);
                    steps.add(step.getSteps());
                }
            }
            Logger.getLogger(ApplConstValues.logName).
                log(Level.INFO, "读取文件{0}成功",file.getName());	
        }
        catch (FileNotFoundException e)
        {
            e.printStackTrace();
			Logger.getLogger(ApplConstValues.logName).
               log(Level.SEVERE, "找不到文件{0}",file.getName());
        	Logger.getLogger(ApplConstValues.logName).
	         log(Level.SEVERE, "执行手册生成失败 ");
			ApplExecuteResultDialog.viewError("执行失败,找不到文件"+file.getName(), "ERROR");
            return false;
        }

        catch (Exception e)
        {
            e.printStackTrace();
            Logger.getLogger(ApplConstValues.logName).
                log(Level.SEVERE, "读取文件{0}失败",file.getName());	
        	Logger.getLogger(ApplConstValues.logName).
	         log(Level.SEVERE, "执行手册生成失败 ");
			ApplExecuteResultDialog.viewError("执行失败,读取"+file.getName()+"失败", "ERROR");
       	    return false;
        }
        return true;
    }
	
	public ArrayList<ApplFrmwkCase> getSteps() {
		return steps;
	}

}
